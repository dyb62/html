/***
 * Clash Verge Rev / Mihomo Party ä¼˜åŒ–è„šæœ¬ (ç²¾å‡†è¯†åˆ«ç‰ˆ)
 * 
 * ä¿®å¤å†…å®¹ï¼š
 * 1. ä¿®å¤æ­£åˆ™è¯¯åˆ¤ï¼šç»™æ‰€æœ‰è‹±æ–‡ç®€å†™ï¼ˆå¦‚ MY, US, IDï¼‰åŠ ä¸Šå•è¯è¾¹ç•Œ (\b)ï¼Œ
 *    é¿å… "Mygo" è¢«è¯†åˆ«ä¸ºé©¬æ¥è¥¿äºšï¼Œ"Android" è¢«è¯†åˆ«ä¸ºå°å°¼ç­‰é—®é¢˜ã€‚
 * 2. ä¿æŒ 5 ä¸ªæ ¸å¿ƒç­–ç•¥ç»„æ˜¾ç¤ºï¼Œåº•å±‚åœ°åŒºåˆ†ç»„è‡ªåŠ¨éšè—ã€‚
 * 3. åŒ…å«æ¬§æ´²åŠå…¨çƒçƒ­é—¨åœ°åŒºã€‚
 */

// --- 1. é…ç½®åŒºåŸŸ ---

const enable = true;

// åœ°åŒºå®šä¹‰ (ä½¿ç”¨ \b é™åˆ¶è‹±æ–‡ç®€å†™ï¼Œé˜²æ­¢è¯¯åˆ¤)
const regionDefinitions = [
  // --- äºšæ´² (ä¸œäºš/ä¸œå—äºš/å—äºš) ---
  { name: 'HK', regex: /é¦™æ¸¯|ğŸ‡­ğŸ‡°|hongkong|hong kong|\bhk\b/i },
  { name: 'TW', regex: /å°æ¹¾|ğŸ‡¹ğŸ‡¼|taiwan|tai wan|\btw\b/i },
  { name: 'JP', regex: /æ—¥æœ¬|ğŸ‡¯ğŸ‡µ|japan|\bjp\b/i },
  { name: 'KR', regex: /éŸ©å›½|ğŸ‡°ğŸ‡·|korea|\bkr\b/i },
  { name: 'SG', regex: /æ–°åŠ å¡|ğŸ‡¸ğŸ‡¬|singapore|\bsg\b/i },
  { name: 'MY', regex: /é©¬æ¥è¥¿äºš|é©¬æ¥|ğŸ‡²ğŸ‡¾|malaysia|\bmy\b/i }, // å·²ä¿®å¤ï¼šMygoä¸ä¼šå†åŒ¹é…è¿™é‡Œ
  { name: 'TH', regex: /æ³°å›½|ğŸ‡¹ğŸ‡­|thailand|\bth\b/i },
  { name: 'VN', regex: /è¶Šå—|ğŸ‡»ğŸ‡³|vietnam|\bvn\b/i },
  { name: 'PH', regex: /è²å¾‹å®¾|ğŸ‡µğŸ‡­|philippines|\bph\b/i },
  { name: 'ID', regex: /å°å°¼|å°åº¦å°¼è¥¿äºš|ğŸ‡®ğŸ‡©|indonesia|\bid\b/i }, // ä¿®å¤ï¼šé¿å…åŒ¹é… android, video
  { name: 'IN', regex: /å°åº¦(?!å°¼)|ğŸ‡®ğŸ‡³|india|\bin\b/i }, // ä¿®å¤ï¼šé¿å…åŒ¹é… ping, bin
  { name: 'IL', regex: /ä»¥è‰²åˆ—|ğŸ‡®ğŸ‡±|israel|\bil\b/i },

  // --- åŒ—ç¾ ---
  { name: 'US', regex: /ç¾å›½|ğŸ‡ºğŸ‡¸|united states|usa|\bus\b/i }, // ä¿®å¤ï¼šé¿å…åŒ¹é… plus, bus
  { name: 'CA', regex: /åŠ æ‹¿å¤§|ğŸ‡¨ğŸ‡¦|canada|\bca\b/i },
  { name: 'MX', regex: /å¢¨è¥¿å“¥|ğŸ‡²ğŸ‡½|mexico|\bmx\b/i },

  // --- æ¬§æ´² ---
  { name: 'UK', regex: /è‹±å›½|ğŸ‡¬ğŸ‡§|united kingdom|great britain|\buk\b/i },
  { name: 'DE', regex: /å¾·å›½|ğŸ‡©ğŸ‡ª|germany|\bde\b/i },
  { name: 'FR', regex: /æ³•å›½|ğŸ‡«ğŸ‡·|france|\bfr\b/i },
  { name: 'NL', regex: /è·å…°|ğŸ‡³ğŸ‡±|netherlands|\bnl\b/i },
  { name: 'IT', regex: /æ„å¤§åˆ©|ğŸ‡®ğŸ‡¹|italy|\bit\b/i },
  { name: 'RU', regex: /ä¿„ç½—æ–¯|ğŸ‡·ğŸ‡º|russia|\bru\b/i },
  { name: 'ES', regex: /è¥¿ç­ç‰™|ğŸ‡ªğŸ‡¸|spain|\bes\b/i },
  { name: 'PT', regex: /è‘¡è„ç‰™|ğŸ‡µğŸ‡¹|portugal|\bpt\b/i },
  { name: 'CH', regex: /ç‘å£«|ğŸ‡¨ğŸ‡­|switzerland|\bch\b/i },
  { name: 'SE', regex: /ç‘å…¸|ğŸ‡¸ğŸ‡ª|sweden|\bse\b/i },
  { name: 'NO', regex: /æŒªå¨|ğŸ‡³ğŸ‡´|norway|\bno\b/i },
  { name: 'FI', regex: /èŠ¬å…°|ğŸ‡«ğŸ‡®|finland|\bfi\b/i },
  { name: 'DK', regex: /ä¸¹éº¦|ğŸ‡©ğŸ‡°|denmark|\bdk\b/i },
  { name: 'IE', regex: /çˆ±å°”å…°|ğŸ‡®ğŸ‡ª|ireland|\bie\b/i },
  { name: 'BE', regex: /æ¯”åˆ©æ—¶|ğŸ‡§ğŸ‡ª|belgium|\bbe\b/i },
  { name: 'AT', regex: /å¥¥åœ°åˆ©|ğŸ‡¦ğŸ‡¹|austria|\bat\b/i }, // ä¿®å¤ï¼šé¿å…åŒ¹é… cat, late
  { name: 'PL', regex: /æ³¢å…°|ğŸ‡µğŸ‡±|poland|\bpl\b/i },
  { name: 'CZ', regex: /æ·å…‹|ğŸ‡¨ğŸ‡¿|czech|\bcz\b/i },
  { name: 'UA', regex: /ä¹Œå…‹å…°|ğŸ‡ºğŸ‡¦|ukraine|\bua\b/i },
  { name: 'TR', regex: /åœŸè€³å…¶|ğŸ‡¹ğŸ‡·|turkey|\btr\b/i },
  { name: 'RO', regex: /ç½—é©¬å°¼äºš|ğŸ‡·ğŸ‡´|romania|\bro\b/i },
  { name: 'HU', regex: /åŒˆç‰™åˆ©|ğŸ‡­ğŸ‡º|hungary|\bhu\b/i },

  // --- å¤§æ´‹æ´² ---
  { name: 'AU', regex: /æ¾³å¤§åˆ©äºš|æ¾³æ´²|ğŸ‡¦ğŸ‡º|australia|\bau\b/i },
  { name: 'NZ', regex: /æ–°è¥¿å…°|ğŸ‡³ğŸ‡¿|new zealand|\bnz\b/i },

  // --- å—ç¾ ---
  { name: 'BR', regex: /å·´è¥¿|ğŸ‡§ğŸ‡·|brazil|\bbr\b/i },
  { name: 'AR', regex: /é˜¿æ ¹å»·|ğŸ‡¦ğŸ‡·|argentina|\bar\b/i },
  { name: 'CL', regex: /æ™ºåˆ©|ğŸ‡¨ğŸ‡±|chile|\bcl\b/i },

  // --- éæ´² ---
  { name: 'ZA', regex: /å—é|ğŸ‡¿ğŸ‡¦|south africa|\bza\b/i },
  { name: 'EG', regex: /åŸƒåŠ|ğŸ‡ªğŸ‡¬|egypt|\beg\b/i },
  { name: 'NG', regex: /å°¼æ—¥åˆ©äºš|ğŸ‡³ğŸ‡¬|nigeria|\bng\b/i }
];

// å—…æ¢è·³è¿‡çš„IPæ®µ
const skipIps = ['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '169.254.0.0/16', '127.0.0.0/8', 'FC00::/7', 'FE80::/10', '::1/128'];

// --- ç”¨æˆ·æŒ‡å®šçš„ç›´è¿è§„åˆ™ ---
const userDirectRules = [
  "DOMAIN-SUFFIX,bilibili.com,DIRECT",
  "DOMAIN-SUFFIX,qq.com,DIRECT",
  "DOMAIN-SUFFIX,seedhub.cc,DIRECT",
  "DOMAIN-SUFFIX,yingmiwo.me,DIRECT",
  "DOMAIN-SUFFIX,wormhole.app,DIRECT",
  "DOMAIN-SUFFIX,aliyun.com,DIRECT",
  "DOMAIN-SUFFIX,pipiyao.pro,DIRECT",
  "DOMAIN-SUFFIX,hhkan4.com,DIRECT",
  "DOMAIN-SUFFIX,pubgmap.top,DIRECT",
  "DOMAIN-SUFFIX,doc2x.noedgeai.com,DIRECT",
  "DOMAIN-SUFFIX,huya.com,DIRECT",
  "DOMAIN-SUFFIX,douyu.com,DIRECT",
  "DOMAIN-SUFFIX,quark.cn,DIRECT",
  "DOMAIN-SUFFIX,chaoxing.com,DIRECT",
  "DOMAIN-SUFFIX,douyin.com,DIRECT",
  "DOMAIN-SUFFIX,xiaoheihe.cn,DIRECT",
  "DOMAIN-SUFFIX,doubao.com,DIRECT",
  "DOMAIN-SUFFIX,deepseek.com,DIRECT",
  "DOMAIN-SUFFIX,csdn.net,DIRECT",
  "DOMAIN-SUFFIX,aihome.chat,DIRECT",
  "DOMAIN-SUFFIX,itdog.cn,DIRECT",
  "PROCESS-NAME,wetype_installer.exe,DIRECT",
  "PROCESS-NAME,wetype_renderer.exe,DIRECT",
  "PROCESS-NAME,wetype_server.exe,DIRECT",
  "PROCESS-NAME,wetype_service.exe,DIRECT",
  "PROCESS-NAME,wetype_update.exe,DIRECT",
  "PROCESS-NAME,GameViewer.exe,DIRECT",
  "PROCESS-NAME,GameViewerService.exe,DIRECT"
];

// åŸºç¡€å±€åŸŸç½‘ç›´è¿è§„åˆ™
const lanDirectRules = [
  'IP-CIDR,10.0.0.0/8,DIRECT,no-resolve',
  'IP-CIDR,172.16.0.0/12,DIRECT,no-resolve',
  'IP-CIDR,192.168.0.0/16,DIRECT,no-resolve',
  'IP-CIDR,127.0.0.0/8,DIRECT,no-resolve',
  'IP-CIDR6,::1/128,DIRECT,no-resolve',
  'IP-CIDR6,fc00::/7,DIRECT,no-resolve',
  'IP-CIDR6,fe80::/10,DIRECT,no-resolve'
];

// --- 2. ä¸»é€»è¾‘ ---

function main(config) {
  if (!enable) return config;

  const proxies = config?.proxies || [];
  if (proxies.length === 0) {
    throw new Error('é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•èŠ‚ç‚¹');
  }

  // 2.1 åŸºç¡€è®¾ç½®
  config['allow-lan'] = true;
  config['mode'] = 'rule';
  config['unified-delay'] = true;
  config['tcp-concurrent'] = true;
  if (config.dns) delete config.dns;

  config['sniffer'] = {
    enable: true,
    'force-dns-mapping': true,
    'parse-pure-ip': true,
    'override-destination': true,
    sniff: { TLS: { ports: [443, 8443] }, HTTP: { ports: [80, '8080-8880'] }, QUIC: { ports: [443, 8443] } },
    'skip-dst-address': skipIps
  };

  config['tun'] = {
    stack: 'mixed',
    'auto-route': true,
    'auto-detect-interface': true,
    'dns-hijack': ['any:53']
  };

  // 2.2 èŠ‚ç‚¹åˆ†ç±»ä¸éšè—åˆ†ç»„ç”Ÿæˆ
  const allProxyNames = proxies.map(p => p.name);
  const regionGroups = {};
  const generatedGroups = [];

  // åˆå§‹åŒ–æ‰€æœ‰åœ°åŒº
  regionDefinitions.forEach(r => regionGroups[r.name] = { ...r, proxies: [] });

  // éå†èŠ‚ç‚¹è¿›è¡Œå½’ç±»
  proxies.forEach(proxy => {
    for (const region of regionDefinitions) {
      if (region.regex.test(proxy.name)) {
        regionGroups[region.name].proxies.push(proxy.name);
        break;
      }
    }
  });

  const regionAutoGroupNames = [];
  
  regionDefinitions.forEach(r => {
    const groupData = regionGroups[r.name];
    if (groupData.proxies.length > 0) {
      const groupName = `${r.name}-è‡ªåŠ¨é€‰æ‹©`;
      regionAutoGroupNames.push(groupName);
      // hidden: true ç¡®ä¿è¿™äº›ç»„ä¸æ˜¾ç¤ºåœ¨é¢æ¿ä¸Š
      generatedGroups.push({
        name: groupName,
        type: 'url-test',
        url: 'http://www.gstatic.com/generate_204',
        interval: 300,
        tolerance: 50,
        proxies: groupData.proxies,
        hidden: true 
      });
    }
  });

  // å…¨çƒè‡ªåŠ¨é€‰æ‹© (éšè—)
  const allAutoGroupName = 'ALL-è‡ªåŠ¨é€‰æ‹©';
  generatedGroups.push({
    name: allAutoGroupName,
    type: 'url-test',
    url: 'http://www.gstatic.com/generate_204',
    interval: 300,
    tolerance: 50,
    proxies: allProxyNames,
    hidden: true
  });
  regionAutoGroupNames.push(allAutoGroupName);

  // 2.3 æ„å»º5ä¸ªæ ¸å¿ƒç­–ç•¥ç»„

  // 1. ğŸ¯æ‰‹åŠ¨é€‰æ‹©
  const groupManual = {
    name: 'ğŸ¯æ‰‹åŠ¨é€‰æ‹©',
    type: 'select',
    proxies: allProxyNames
  };

  // 2. ğŸ¤–è‡ªåŠ¨é€‰æ‹© (åŒ…å«éšè—çš„åœ°åŒºåˆ†ç»„)
  const groupAuto = {
    name: 'ğŸ¤–è‡ªåŠ¨é€‰æ‹©',
    type: 'select',
    proxies: regionAutoGroupNames
  };

  // 3. ğŸ”€è´Ÿè½½å‡è¡¡(æ•£åˆ—)
  const groupHash = {
    name: 'ğŸ”€è´Ÿè½½å‡è¡¡(æ•£åˆ—)',
    type: 'load-balance',
    strategy: 'consistent-hashing',
    url: 'http://www.gstatic.com/generate_204',
    interval: 300,
    proxies: allProxyNames
  };

  // 4. ğŸ”è´Ÿè½½å‡è¡¡(è½®è¯¢)
  const groupRoundRobin = {
    name: 'ğŸ”è´Ÿè½½å‡è¡¡(è½®è¯¢)',
    type: 'load-balance',
    strategy: 'round-robin',
    url: 'http://www.gstatic.com/generate_204',
    interval: 300,
    proxies: allProxyNames
  };

  // 5. ğŸ›œä»£ç†æ¨¡å¼
  const groupProxyMode = {
    name: 'ğŸ›œä»£ç†æ¨¡å¼',
    type: 'select',
    proxies: ['ğŸ¤–è‡ªåŠ¨é€‰æ‹©', 'ğŸ¯æ‰‹åŠ¨é€‰æ‹©', 'ğŸ”€è´Ÿè½½å‡è¡¡(æ•£åˆ—)', 'ğŸ”è´Ÿè½½å‡è¡¡(è½®è¯¢)', 'DIRECT']
  };

  // 2.4 ç»„è£…
  config['proxy-groups'] = [
    groupProxyMode,
    groupManual,
    groupAuto,
    groupHash,
    groupRoundRobin,
    ...generatedGroups
  ];

  // 2.5 è§„åˆ™
  config['rules'] = [
    ...userDirectRules,
    ...lanDirectRules,
    'MATCH,ğŸ›œä»£ç†æ¨¡å¼'
  ];

  delete config['rule-providers'];

  return config;
}
